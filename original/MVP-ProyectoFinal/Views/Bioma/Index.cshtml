@model List<MVP_ProyectoFinal.Models.ResultadoIntentoBiomaVM>
@{
    ViewData["Title"] = "Guess the Biome";
}



<div class="text-center game-container">
    <h1 class="game-title">Guess the Biome</h1>
    <div class="game-toolbar">
        <a asp-controller="Bioma" asp-action="Reiniciar" class="btn btn-outline-secondary btn-sm">Restart Game</a>
        <a asp-controller="Juego" asp-action="Index" class="btn btn-outline-primary btn-sm">Switch to Blocks</a>
        <a asp-controller="Entidad" asp-action="Index" class="btn btn-outline-success btn-sm">Switch to Entities</a>
    </div>

    @if (TempData["MensajeVictoria"] != null)
    {
        <h2 class="alert alert-success">@TempData["MensajeVictoria"]</h2>
        <a asp-controller="Bioma" asp-action="Reiniciar" class="btn btn-primary btn-lg mt-3">Play Again</a>
    }
    else
    {
        <form asp-controller="Bioma" asp-action="Adivinar" method="post" class="mb-3 game-guess-form">
            <div>
                <input type="text" name="nombreBioma" id="nombreBiomaInput" placeholder="Type a biome..." required autofocus
                       class="form-control game-guess-input" autocomplete="off" />
                <div id="sugerencias-container"></div>
            </div>
            <button type="submit" class="btn btn-primary">Guess</button>
        </form>
        <form asp-controller="Bioma" asp-action="GiveUp" method="post" class="mb-3 game-giveup-form">
            <button type="submit" class="btn btn-outline-danger btn-sm">Give Up</button>
        </form>

        @if (TempData["Error"] != null)
        {
            <p class="alert alert-danger">@TempData["Error"]</p>
        }
    }

    @if (Model != null && Model.Any())
    {
        <table class="table table-bordered game-table mt-4">
            <thead class="table-dark">
                <tr>
                    <th>Biome</th>
                    <th>Name Length</th>
                    <th>Initial</th>
                    <th>Climate</th>
                    <th>Precipitation</th>
                    <th>Dimension</th>
                    <th>Height</th>
                    <th>Year</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var attempt in Model)
                {
                    <tr>
                        <td>@attempt.NombreBioma</td>
                        <td class="@attempt.ColorLongitudNombre">@attempt.LongitudNombre @attempt.HintLongitudNombre</td>
                        <td class="@attempt.ColorCoincideInicial">@attempt.CoincideInicial</td>
                        <td class="@attempt.ColorClima">@attempt.Clima @attempt.HintClima</td>
                        <td class="@attempt.ColorPrecipitacion">@attempt.Precipitacion @attempt.HintPrecipitacion</td>
                        <td class="@attempt.ColorDimension">@attempt.Dimension</td>
                        <td class="@attempt.ColorAltura">@attempt.Altura @attempt.HintAltura</td>
                        <td class="@attempt.ColorAnio">@attempt.YearLanzamiento (@attempt.VersionLanzamiento) @attempt.HintAnio</td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('nombreBiomaInput');
            const container = document.getElementById('sugerencias-container');
            if (input && container) {
                container.style.width = input.offsetWidth + 'px';
                input.addEventListener('input', async function () {
                    const term = input.value;
                    container.style.width = input.offsetWidth + 'px';
                    if (term.length < 1) { container.innerHTML = ''; return; }
                    try {
                        const response = await fetch(`/Bioma/SugerirBiomas?term=${encodeURIComponent(term)}`);
                        if (!response.ok) return;
                        const suggestions = await response.json();
                        container.innerHTML = '';
                        suggestions.forEach(s => {
                            const div = document.createElement('div');
                            div.textContent = s;
                            div.classList.add('sugerencia-item');
                            div.addEventListener('click', function () {
                                input.value = s;
                                container.innerHTML = '';
                                input.focus();
                            });
                            container.appendChild(div);
                        });
                    } catch (error) { console.error('Error:', error); }
                });
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        const first = container.querySelector('.sugerencia-item');
                        if (first) {
                            e.preventDefault();
                            input.value = first.textContent;
                            container.innerHTML = '';
                            const form = input.closest('form');
                            if (form) {
                                form.submit();
                            }
                        }
                    }
                });
                document.addEventListener('click', function (e) {
                    if (e.target !== input) {
                        container.innerHTML = '';
                    }
                });
            }
        });
    </script>
}
