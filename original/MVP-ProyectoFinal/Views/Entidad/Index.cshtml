@model List<MVP_ProyectoFinal.Models.ResultadoIntentoEntidadVM>
@{
    ViewData["Title"] = "Guess the Entity";
}



<div class="text-center game-container">
    <h1 class="game-title">Guess the Entity</h1>
    <div class="game-toolbar">
        <a asp-controller="Entidad" asp-action="Reiniciar" class="btn btn-outline-secondary btn-sm">Restart Game</a>
        <a asp-controller="Juego" asp-action="Index" class="btn btn-outline-primary btn-sm">Switch to Blocks</a>
        <a asp-controller="Bioma" asp-action="Index" class="btn btn-outline-warning btn-sm">Switch to Biomes</a>
    </div>

    @if (TempData["MensajeVictoria"] != null)
    {
        <h2 class="alert alert-success">@TempData["MensajeVictoria"]</h2>
        <a asp-controller="Entidad" asp-action="Reiniciar" class="btn btn-primary btn-lg mt-3">Play Again</a>
    }
    else
    {
        <form asp-controller="Entidad" asp-action="Adivinar" method="post" class="mb-3 game-guess-form">
            <div>
                <input type="text" name="nombreEntidad" id="nombreEntidadInput" placeholder="Type an entity..." required autofocus
                       class="form-control game-guess-input" autocomplete="off" />
                <div id="sugerencias-container"></div>
            </div>
            <button type="submit" class="btn btn-primary">Guess</button>
        </form>
        <form asp-controller="Entidad" asp-action="GiveUp" method="post" class="mb-3 game-giveup-form">
            <button type="submit" class="btn btn-outline-danger btn-sm">Give Up</button>
        </form>

        @if (TempData["Error"] != null)
        {
            <p class="alert alert-danger">@TempData["Error"]</p>
        }
    }

    @if (Model != null && Model.Any())
    {
        <table class="table table-bordered game-table mt-4">
            <thead class="table-dark">
                <tr>
                    <th>Entity</th>
                    <th>Name Length</th>
                    <th>Initial</th>
                    <th>Type</th>
                    <th>Health</th>
                    <th>Attack</th>
                    <th>Dimension</th>
                    <th>Year</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var intento in Model)
                {
                    <tr>
                        <td>@intento.NombreEntidad</td>
                        <td class="@intento.ColorLongitudNombre">@intento.LongitudNombre @intento.HintLongitudNombre</td>
                        <td class="@intento.ColorCoincideInicial">@intento.CoincideInicial</td>
                        <td class="@intento.ColorTipo">@intento.Tipo</td>
                        <td class="@intento.ColorVida">@intento.Vida @intento.HintVida</td>
                        <td class="@intento.ColorAtaque">@intento.Ataque @intento.HintAtaque</td>
                        <td class="@intento.ColorDimension">@intento.Dimension</td>
                        <td class="@intento.ColorAnio">@intento.YearLanzamiento @intento.HintAnio</td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('nombreEntidadInput');
            const container = document.getElementById('sugerencias-container');
            if (input && container) {
                container.style.width = input.offsetWidth + 'px';
                input.addEventListener('input', async function () {
                    const term = input.value;
                    container.style.width = input.offsetWidth + 'px';
                    if (term.length < 1) { container.innerHTML = ''; return; }
                    try {
                        const response = await fetch(`/Entidad/SugerirEntidades?term=${encodeURIComponent(term)}`);
                        if (!response.ok) return;
                        const sugerencias = await response.json();
                        container.innerHTML = '';
                        sugerencias.forEach(sugerencia => {
                            const div = document.createElement('div');
                            div.textContent = sugerencia;
                            div.classList.add('sugerencia-item');
                            div.addEventListener('click', function () {
                                input.value = sugerencia;
                                container.innerHTML = '';
                                input.focus();
                            });
                            container.appendChild(div);
                        });
                    } catch (error) { console.error('Error:', error); }
                });
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        const first = container.querySelector('.sugerencia-item');
                        if (first) {
                            e.preventDefault();
                            input.value = first.textContent;
                            container.innerHTML = '';
                            const form = input.closest('form');
                            if (form) {
                                form.submit();
                            }
                        }
                    }
                });
                document.addEventListener('click', function (e) {
                    if (e.target !== input) { container.innerHTML = ''; }
                });
            }
        });
    </script>
}